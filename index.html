<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-12-15 Thu 11:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="author" content="joshua" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="https://distro.tube/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://distro.tube/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js" integrity="sha512-GA1YgNe8NTU3XMDMofUTpTNqMsPUL6VjYgc6NjOUTA/6pwTFlTmFc/tk+LnDfXD3/mNGZcik9kvfAjeVPTHisA==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
<link rel="stylesheet" type="text/css" href="styles.css" title="custom"/>
<script src="script.js" defer></script>
</head>
<body>
<div id="content" class="content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org3515b37">Prerequisites</a></li>
<li><a href="#orgc13be5d">Overview</a></li>
<li><a href="#org92ac1e4">Namespaces</a></li>
<li><a href="#orgfb05ace">Pods</a></li>
<li><a href="#orgbc50e3a">Services</a></li>
<li><a href="#org7acb93f">ConfigMaps</a></li>
<li><a href="#orgf6912a9">Secrets</a></li>
<li><a href="#org087477d">Deployments</a></li>
<li><a href="#org955d05c">MongoDB Setup</a>
<ul>
<li><a href="#org2ba7cc1">ConfigMap</a></li>
<li><a href="#org52d5a27">Service</a></li>
<li><a href="#orgba6bd04">Secret</a></li>
<li><a href="#org9efaa0d">Deployment</a></li>
</ul>
</li>
<li><a href="#orgb2d2de3">Node Application Setup</a>
<ul>
<li><a href="#orgd6790d6">Service</a></li>
<li><a href="#org964601b">Deployment</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org3515b37" class="outline-2">
<h2 id="org3515b37">Prerequisites</h2>
<div class="outline-text-2" id="text-org3515b37">
<p>
You will need to have Kubernetes installed. The easiest way to do with is with <a href="https://minikube.sigs.k8s.io/docs/start/">minikube</a>. In order to have <code>minikube</code> installed, you'll need to have <a href="https://docs.docker.com/get-docker/">docker</a> installed. You can technically run <code>minikube</code> in a virtual machine but <code>docker</code> is easiest.
</p>

<p>
<code>minikube</code> creates a <code>docker</code> container in which we can run&#x2026; containers.
</p>


<div id="orgabe8a52" class="figure">
<p><img src="./container.jpeg" alt="container.jpeg" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgc13be5d" class="outline-2">
<h2 id="orgc13be5d">Overview</h2>
<div class="outline-text-2" id="text-orgc13be5d">
<p>
Most things in Kubernetes are <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects/">Kubernetes Objects</a>. Objects are the basic Kubernetes building blocks and they DE-scribe the way you expect your cluster to be. Most deployable objects are configured through <code>spec</code> properties as you'll see shortly.
</p>

<p>
In this demo, I'm going to spin up a few different types of basic Objects. The main and most efficient way of interacting with interacting with Objects is using the <code>kubectl</code> cli which comes bundled with <code>minikube</code>. The main things we're going to go over and the main things to be done with Objects are:
</p>

<ul class="org-ul">
<li>Creating Objects (<code>kubectl create &lt;KUBERNETES_OBJECT&gt;</code>)</li>
<li>Deleting Objects (<code>kubectl delete &lt;KUBERNETES_OBJECT&gt;</code>)</li>
<li>Applying files (<code>kubectl apply -f &lt;FILE&gt;.yaml</code>) -
<ul class="org-ul">
<li><code>.json</code> files can also be applied. The syntax almost identical to <code>.yaml</code> files, only a bit more verbose.</li>
<li>files do not have to be local. You can use http to access files on the internet. kubernetes.io has the following example:
<ul class="org-ul">
<li><code>kubectl apply -f https://k8s.io/examples/pods/simple-pod.yaml</code></li>
</ul></li>
</ul></li>
</ul>

<p>
Applying a file will either create the object if it doesn't exist or edit the existing object.
</p>

<p>
There are a few ways to view the Objects that have been created. Namely the commands:
</p>

<ul class="org-ul">
<li><code>kubectl get &lt;OBJECT_TYPE&gt;</code></li>
<li><code>kubectl describe &lt;OBJECT_TYPE&gt; &lt;SPECIFIC_OBJECT&gt;</code>
<ul class="org-ul">
<li><code>kubectl get pod &lt;POD_NAME&gt;</code> for example.</li>
</ul></li>
</ul>


<p>
Throughout, I will be using evaluating code blocks on the fly which is essentially equivalent to <code>kubectl apply -f</code> and showing the Kubernetes Objects I've created with a wrapper around <code>kubectl</code> which essentially functions like a <code>kubectl get &lt;OBJECT_NAME&gt;</code>. I will demonstrate the first few by applying them through the command line and running the describe and get commands, but for the most part I will use my wrapper around <code>kubectl</code>.
</p>

<p>
A list of all <code>kubectl</code> commands can be found <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">here</a>.
</p>

<p>
The goal of this demonstration will be to walk you through a basic web app with a persistent backend all set up using Kubernetes Objects.
</p>
</div>
</div>

<div id="outline-container-org92ac1e4" class="outline-2">
<h2 id="org92ac1e4">Namespaces</h2>
<div class="outline-text-2" id="text-org92ac1e4">
<p>
<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">Namespaces</a> are ways of grouping Kubernetes resources. The best way of using namespaces is to think of them as groups of related Objects. A namespace is itself an Object and therefore can be created with the standard <code>kubectl</code> commands or with a file.
</p>

<div class="org-src-container">
<pre class="src src-kubectl"><span style="color: #6272a4;"># </span><span style="color: #6272a4;">example-namespace.yaml</span>
<span style="color: #ffc9e8;">apiVersion</span>: v1
<span style="color: #ffc9e8;">kind</span>: Namespace
<span style="color: #ffc9e8;">metadata</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: my-new-namespace
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">labels</span>:
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">name</span>: my-new-namespace
</pre>
</div>

<pre class="example">
namespace/my-new-namespace created
</pre>



<p>
We will proceed with the default namespace and the kubernetes documentation recommends only using the default namespace unless you're in a large team with many objects that need different resource allocation.
</p>
</div>
</div>

<div id="outline-container-orgfb05ace" class="outline-2">
<h2 id="orgfb05ace">Pods</h2>
<div class="outline-text-2" id="text-orgfb05ace">
<p>
<a href="../../../org-roam/20221213120027-kubernetes_pods.html#ID-0735aeee-cd38-4a96-aacc-27f90aa24a01">Kubernetes Pods</a>:
</p>
<ul class="org-ul">
<li>consist of containers and resources.</li>
<li>typically have one container, but can contain many.</li>
</ul>

<p>
Think of them as wrappers around docker containers (though they do not have to be docker specifically) which allows you to interface with them using the <code>kubectl</code> api. Pods are the smallest deployable unit in Kubernetes. A simple example of a pod from the Kubernetes documentation is as follows:
</p>

<div class="org-src-container">
<pre class="src src-kubectl"><span style="color: #6272a4;"># </span><span style="color: #6272a4;">example-nginx-pod.yaml</span>
<span style="color: #ffc9e8;">apiVersion</span>: v1
<span style="color: #ffc9e8;">kind</span>: Pod
<span style="color: #ffc9e8;">metadata</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: nginx
<span style="color: #ffc9e8;">spec</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">containers</span>:
<span style="background-color: #373844;"> </span> - <span style="color: #ffc9e8;">name</span>: nginx
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">image</span>: nginx:1.14.2
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">ports</span>:
<span style="background-color: #373844;"> </span>   - <span style="color: #ffc9e8;">containerPort</span>: 80
</pre>
</div>

<pre class="example">
pod/nginx created
</pre>


<p>
Pods have their own IP addresses and can be accessed through standard protocols (TCP, UDP, SCTP). But pods can be spun up and spun down giving them new IP addresses each time. To avoid this, Kubernetes has a concept known as 
</p>
</div>
</div>

<div id="outline-container-orgbc50e3a" class="outline-2">
<h2 id="orgbc50e3a">Services</h2>
<div class="outline-text-2" id="text-orgbc50e3a">
<p>
A service is a creating a logical set of pods and ways to communicate between them. Given that Pods are spun up and spun down in order to meet the desired state of the application, we need a way of tracking them that doesn't rely on knowledge of the specific IP addresses.
</p>

<p>
Services need a few properties to function correctly. Firstly, they need a <code>selector</code>. This will tell the service which it's associated with. Second, you will need to specify the <code>port</code> the service is open on and the <code>targetPort</code> the deployment is running the pods on. This is so that the service correctly forwards the request it receives to the right pods.
</p>

<p>
Additionally, Services act as load balancers and by default direct traffic to the least busy pod of all the replicas.
</p>
</div>
</div>

<div id="outline-container-org7acb93f" class="outline-2">
<h2 id="org7acb93f">ConfigMaps</h2>
<div class="outline-text-2" id="text-org7acb93f">
<p>
ConfigMaps are key/value stores typically used for configuration data. They're referenced in other Objects by name via <code>configMapKeyRef</code>. As many values as one wnats can be created. We will show a demo of a ConfigMap later.
</p>
</div>
</div>

<div id="outline-container-orgf6912a9" class="outline-2">
<h2 id="orgf6912a9">Secrets</h2>
<div class="outline-text-2" id="text-orgf6912a9">
<p>
Like ConfigMaps, Secrets are key value stores, but their purpose is so we're not accessing things like passwords and tokens directly inside pods as environmental variables. They're managed by Kubernetes and the values are required to be base64 encoded.
</p>
</div>
</div>

<div id="outline-container-org087477d" class="outline-2">
<h2 id="org087477d">Deployments</h2>
<div class="outline-text-2" id="text-org087477d">
<p>
Deployments are an abstraction over pods. In practice, what will be used most is deployments. It's unlikely that you would spin up a pod on it's own because Kubernetes manages pods through deployments. In order to know what services the deployment needs to get traffic from, we have to add a <code>matchLabels</code> property to the <code>spec</code>. Deployments also tell us how many replicas of a given pod we need.
</p>
</div>
</div>

<div id="outline-container-org955d05c" class="outline-2">
<h2 id="org955d05c">MongoDB Setup</h2>
<div class="outline-text-2" id="text-org955d05c">
</div>
<div id="outline-container-org2ba7cc1" class="outline-3">
<h3 id="org2ba7cc1">ConfigMap</h3>
<div class="outline-text-3" id="text-org2ba7cc1">
<p>
Here, instead of hard-coding an ip address for the pod our deployment will create, we're going to reference the subsequent service that gets created. We will need this in our node application in order to access mongo.
</p>

<div class="org-src-container">
<pre class="src src-kubectl"><span style="color: #6272a4;"># </span><span style="color: #6272a4;">mongo-config.yaml</span>
<span style="color: #ffc9e8;">apiVersion</span>: v1
<span style="color: #ffc9e8;">kind</span>: ConfigMap
<span style="color: #ffc9e8;">metadata</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: mongo-config
<span style="color: #ffc9e8;">data</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">mongo-url</span>: mongo-service <span style="color: #6272a4;"># </span><span style="color: #6272a4;">to be created</span>
</pre>
</div>

<pre class="example">
configmap/mongo-config created
</pre>
</div>
</div>

<div id="outline-container-org52d5a27" class="outline-3">
<h3 id="org52d5a27">Service</h3>
<div class="outline-text-3" id="text-org52d5a27">
<p>
This service tells us what port we want to access the service through as well as which port to target and specifies a selector we will use to match in our deployment.
</p>

<div class="org-src-container">
<pre class="src src-kubectl"><span style="color: #6272a4;"># </span><span style="color: #6272a4;">mongo-config.yaml</span>
<span style="color: #6272a4;">---</span>
<span style="color: #ffc9e8;">apiVersion</span>: v1
<span style="color: #ffc9e8;">kind</span>: Service
<span style="color: #ffc9e8;">metadata</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: mongo-service
<span style="color: #ffc9e8;">spec</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">selector</span>:
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">app</span>: mongo
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">ports</span>:
<span style="background-color: #373844;"> </span>   - <span style="color: #ffc9e8;">protocol</span>: TCP
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">port</span>: 27017
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">targetPort</span>: 27017 <span style="color: #6272a4;"># </span><span style="color: #6272a4;">the container port we are targeting when our service gets a request</span>
</pre>
</div>

<pre class="example">
service/mongo-service created
</pre>
</div>
</div>

<div id="outline-container-orgba6bd04" class="outline-3">
<h3 id="orgba6bd04">Secret</h3>
<div class="outline-text-3" id="text-orgba6bd04">
<p>
First, let's encode the user:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ffb86c;">echo</span> -n mongouser | base64
</pre>
</div>

<pre class="example">
bW9uZ291c2Vy
</pre>


<p>
Then we'll encode the password:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ffb86c;">echo</span> -n mongopassword | base64
</pre>
</div>

<pre class="example">
bW9uZ29wYXNzd29yZA==
</pre>


<p>
After, we can use those values to create our Mongo secret.
</p>
<div class="org-src-container">
<pre class="src src-kubectl"><span style="color: #6272a4;"># </span><span style="color: #6272a4;">mongo-secret.yaml</span>
<span style="color: #ffc9e8;">apiVersion</span>: v1
<span style="color: #ffc9e8;">kind</span>: Secret
<span style="color: #ffc9e8;">metadata</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: mongo-secret
<span style="color: #ffc9e8;">type</span>: Opaque
<span style="color: #ffc9e8;">data</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">mongo-user</span>: bW9uZ291c2Vy
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">mongo-password</span>: bW9uZ29wYXNzd29yZA==
</pre>
</div>

<pre class="example">
secret/mongo-secret created
</pre>
</div>
</div>

<div id="outline-container-org9efaa0d" class="outline-3">
<h3 id="org9efaa0d">Deployment</h3>
<div class="outline-text-3" id="text-org9efaa0d">
<p>
In this deployment, we make sure to match up with the mongo service through the <code>matchLabels</code> selector and we configure the environmental variables of our mongo container. This information used therein is referenced from the <a href="https://hub.docker.com/_/mongo">official mongodb documentation on dockerhub</a>.
</p>

<div class="org-src-container">
<pre class="src src-kubectl"><span style="color: #6272a4;"># </span><span style="color: #6272a4;">mongo.yaml</span>
<span style="color: #ffc9e8;">apiVersion</span>: apps/v1
<span style="color: #ffc9e8;">kind</span>: Deployment
<span style="color: #ffc9e8;">metadata</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: mongo-deployment
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">labels</span>:
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">app</span>: mongo
<span style="color: #ffc9e8;">spec</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">replicas</span>: 1
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">selector</span>:
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">matchLabels</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">app</span>: mongo <span style="color: #6272a4;"># </span><span style="color: #6272a4;">matched from our selector in our service</span>
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">template</span>:
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">metadata</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">labels</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">app</span>: mongo
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">spec</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">containers</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> - <span style="color: #ffc9e8;">name</span>: mongodb
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">image</span>: mongo:5.0
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">ports</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   - <span style="color: #ffc9e8;">containerPort</span>: 27017 <span style="color: #6272a4;"># </span><span style="color: #6272a4;">we forward traffic here from our service</span>
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">env</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   - <span style="color: #ffc9e8;">name</span>: MONGO_INITDB_ROOT_USERNAME
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">valueFrom</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">secretKeyRef</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: mongo-secret
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">key</span>: mongo-user
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   - <span style="color: #ffc9e8;">name</span>: MONGO_INITDB_ROOT_PASSWORD
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">valueFrom</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">secretKeyRef</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: mongo-secret
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">key</span>: mongo-password
</pre>
</div>

<pre class="example">
deployment.apps/mongo-deployment created
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb2d2de3" class="outline-2">
<h2 id="orgb2d2de3">Node Application Setup</h2>
<div class="outline-text-2" id="text-orgb2d2de3">
</div>
<div id="outline-container-orgd6790d6" class="outline-3">
<h3 id="orgd6790d6">Service</h3>
<div class="outline-text-3" id="text-orgd6790d6">
<p>
This service will give us access to our web application through <code>minikube</code> via the <code>minikube ip</code>. We define the <code>nodePort</code> as accessible to the outside. Note that Services of type <code>NodePort</code> have to fall within a very specific range (30000-32767).
</p>

<div class="org-src-container">
<pre class="src src-kubectl"><span style="color: #6272a4;"># </span><span style="color: #6272a4;">webapp.yaml</span>
<span style="color: #6272a4;">---</span>
<span style="color: #ffc9e8;">apiVersion</span>: v1
<span style="color: #ffc9e8;">kind</span>: Service
<span style="color: #ffc9e8;">metadata</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: webapp-service
<span style="color: #ffc9e8;">spec</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">type</span>: NodePort
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">selector</span>:
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">app</span>: webapp
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">ports</span>:
<span style="background-color: #373844;"> </span>   - <span style="color: #ffc9e8;">protocol</span>: TCP
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">port</span>: 3000
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">targetPort</span>: 3000
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">nodePort</span>: 30100
</pre>
</div>

<pre class="example">
service/webapp-service created
</pre>
</div>
</div>


<div id="outline-container-org964601b" class="outline-3">
<h3 id="org964601b">Deployment</h3>
<div class="outline-text-3" id="text-org964601b">
<p>
In this deployment, we make sure to match up with the webapp service through the <code>matchLabels</code> selector and we configure the environmental variables and read the values from our config map and secret.
</p>

<div class="org-src-container">
<pre class="src src-kubectl"><span style="color: #6272a4;"># </span><span style="color: #6272a4;">webapp.yaml</span>
<span style="color: #ffc9e8;">apiVersion</span>: apps/v1
<span style="color: #ffc9e8;">kind</span>: Deployment
<span style="color: #ffc9e8;">metadata</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: webapp-deployment
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">labels</span>:
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">app</span>: webapp
<span style="color: #ffc9e8;">spec</span>:
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">replicas</span>: 2
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">selector</span>:
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">matchLabels</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">app</span>: webapp <span style="color: #6272a4;"># </span><span style="color: #6272a4;">matched from our selector in our service</span>
<span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">template</span>:
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">metadata</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">labels</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">app</span>: webapp
<span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">spec</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">containers</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> - <span style="color: #ffc9e8;">name</span>: webapp
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">image</span>: nanajanashia/k8s-demo-app:v1.0
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">ports</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   - <span style="color: #ffc9e8;">containerPort</span>: 3000
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">env</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   - <span style="color: #ffc9e8;">name</span>: USER_NAME
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">valueFrom</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">secretKeyRef</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: mongo-secret
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">key</span>: mongo-user
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   - <span style="color: #ffc9e8;">name</span>: USER_PWD
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">valueFrom</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">secretKeyRef</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: mongo-secret
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">key</span>: mongo-password
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   - <span style="color: #ffc9e8;">name</span>: DB_URL
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">valueFrom</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="color: #ffc9e8;">configMapKeyRef</span>:
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">name</span>: mongo-config
<span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span>   <span style="background-color: #373844;"> </span> <span style="color: #ffc9e8;">key</span>: mongo-url
</pre>
</div>

<pre class="example">
deployment.apps/webapp-deployment created
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: joshua</p>
<p class="date">Created: 2022-12-15 Thu 11:58</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
